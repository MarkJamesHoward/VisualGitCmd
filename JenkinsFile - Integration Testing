pipeline {
    agent any
    stages {        
        stage('Pull latest for VisualGit Cli, API, and Website') {
            steps {
                dir('/VisualGitBuild/VisualGit') {
                    sh 'git -c core.askpass=true pull --no-edit --ff-only || git pull --no-edit || echo Skipping pull - auth or repo issue'
                 }
                dir('/VisualGitBuild/VisualGitCmd') {
                    sh 'git -c core.askpass=true pull --no-edit --ff-only || git pull --no-edit'
                }
                 
                  dir('/VisualGitBuild/VisualGitAPI') {
                    sh 'git -c core.askpass=true pull --no-edit --ff-only || git pull --no-edit || echo Skipping pull - auth or repo issue'
                 }
            }
        }
        stage('Build and run Docker Image of VisualGitCMD for integration tests') {
            steps {
                
                    dir('/VisualGitBuild') {
                        sh 'mkdir -p ActualJson'
                        sh 'mkdir -p ExpectedJson'
                        sh 'cp -r /VisualGitBuild/VisualGitCmd/Test/ExpectedJson/. /VisualGitBuild/ExpectedJson/'
                    }
                
                dir('/VisualGitBuild/docker-test-folder') {
                    
                    sh 'touch test.txt'
                    sh 'echo "test" > test.txt'
                    sh 'rm -rf .git'
                    sh 'git init'
                    sh 'git config --global user.email "markjameshoward@hotmail.co.uk"'
                    sh 'git config --global user.name "Mark Howard"'
                    sh 'git add .'
                    sh 'GIT_COMMITTER_DATE="Sun Aug 4 11:14:08 2024 +0200" git commit -m "initial" --date "Wed Jul 24 19:09:11 2024 +0200"'
                }
                dir('/VisualGitBuild/VisualGitCmd') {
                    sh 'dotnet run --no-launch-profile -- -s -p "/VisualGitBuild/docker-test-folder" -j "/VisualGitBuild/ActualJson"'
                }
            }
        }
        stage('Run VisuaGitCMD Integration Tests on JSON from Docker') {
            steps {
                dir('/VisualGitBuild/VisualGitCmd') {
                    sh 'dotnet test --filter "DockerOutputIntegrationTests"'
                 }
            }
        }        
    }
}
